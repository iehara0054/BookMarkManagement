<?php
/**
 * ã‚·ãƒ³ãƒ—ãƒ«ã‚¿ã‚¹ã‚¯ãƒˆãƒ©ãƒƒã‚«ãƒ¼ - å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«PHPã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
 * 
 * ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ¦‚è¦ã€‘
 * - ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ä¸è¦ã®è»½é‡ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
 * - JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–
 * - CSRFä¿è­·ã€XSSå¯¾ç­–ã€å®‰å…¨ãªãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã‚’å®Ÿè£…
 * 
 * ã€ä¸»è¦æ©Ÿèƒ½ã€‘
 * - ã‚¿ã‚¹ã‚¯ã®è¿½åŠ ã€ä¸€è¦§è¡¨ç¤ºã€å®Œäº†/æœªå®Œäº†ã®åˆ‡ã‚Šæ›¿ãˆã€å‰Šé™¤
 */

// ============================================================================
// ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¨CSRFä¿è­·ã®åˆæœŸåŒ–
// ============================================================================

// ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ - CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã®ä¿å­˜ã«å¿…è¦
// session_start() ã¯HTTPãƒ˜ãƒƒãƒ€ãƒ¼é€ä¿¡å‰ã«å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æœ€åˆã«é…ç½®
session_start();

// --- CSRF token setup ---
// CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆï¼ˆåˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ï¼‰ã«æ–°è¦ç”Ÿæˆ
if (empty($_SESSION['csrf_token'])) {
    // random_bytes(32) ã§32ãƒã‚¤ãƒˆï¼ˆ256ãƒ“ãƒƒãƒˆï¼‰ã®æš—å·å­¦çš„ã«å®‰å…¨ãªä¹±æ•°ã‚’ç”Ÿæˆ
    // bin2hex() ã§ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã‚’16é€²æ•°æ–‡å­—åˆ—ï¼ˆ64æ–‡å­—ï¼‰ã«å¤‰æ›ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
    // ã“ã‚Œã«ã‚ˆã‚Šäºˆæ¸¬ä¸å¯èƒ½ãªãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ã€CSRFæ”»æ’ƒã‚’é˜²ã
    $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
}
// ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å–å¾—ã—ãŸCSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å¤‰æ•°ã«æ ¼ç´ï¼ˆå¾Œã§ãƒ•ã‚©ãƒ¼ãƒ ã«åŸ‹ã‚è¾¼ã‚€ï¼‰
$CSRF = $_SESSION['csrf_token'];

// ============================================================================
// ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã¨å®šæ•°ã®å®šç¾©
// ============================================================================

// --- Helpers ---
// ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
// __DIR__ ã¯ç¾åœ¨ã®PHPãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®çµ¶å¯¾ãƒ‘ã‚¹ã‚’è¿”ã™å®šæ•°
// const ã§å®šæ•°ã¨ã—ã¦å®šç¾©ã™ã‚‹ã“ã¨ã§ã€èª¤ã£ã¦å€¤ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã‚’é˜²ã
const TASKS_FILE = __DIR__ . '/tasks.json';

/**
 * ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€
 * 
 * @return array ã‚¿ã‚¹ã‚¯ã®é…åˆ—ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç©ºé…åˆ—
 * 
 * ã€å‡¦ç†ã®æµã‚Œã€‘
 * 1. ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
 * 2. ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ï¼ˆJSONæ–‡å­—åˆ—ï¼‰ã®èª­ã¿è¾¼ã¿
 * 3. JSONãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã«ãƒ‡ã‚³ãƒ¼ãƒ‰
 * 4. ãƒ‡ã‚³ãƒ¼ãƒ‰çµæœã®æ¤œè¨¼
 */
function load_tasks(): array {
    // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆï¼ˆåˆå›èµ·å‹•æ™‚ï¼‰ã¯ç©ºé…åˆ—ã‚’è¿”ã™
    // ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„çŠ¶æ…‹ã§ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãšã€æ–°è¦ã«ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã§ãã‚‹
    if (!file_exists(TASKS_FILE)) {
        return [];
    }
    // file_get_contents() ã§ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã‚’æ–‡å­—åˆ—ã¨ã—ã¦èª­ã¿è¾¼ã¿
    $json = file_get_contents(TASKS_FILE);
    // json_decode() ã®ç¬¬2å¼•æ•° true ã§ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ãªãé€£æƒ³é…åˆ—ã¨ã—ã¦å–å¾—
    $data = json_decode($json, true);
    // json_decode() ãŒå¤±æ•—ã—ãŸå ´åˆã¯ null ã‚’è¿”ã™ãŸã‚ã€é…åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
    // is_array() ã§æ¤œè¨¼ã—ã€é…åˆ—ã§ãªã„å ´åˆã¯ç©ºé…åˆ—ã‚’è¿”ã—ã¦å®‰å…¨æ€§ã‚’ç¢ºä¿
    return is_array($data) ? $data : [];
}

/**
 * ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
 * 
 * @param array $tasks ä¿å­˜ã™ã‚‹ã‚¿ã‚¹ã‚¯ã®é…åˆ—
 * @return void
 * 
 * ã€é‡è¦ãªå®Ÿè£…ãƒã‚¤ãƒ³ãƒˆã€‘
 * - ã‚¢ãƒˆãƒŸãƒƒã‚¯ãªæ›¸ãè¾¼ã¿ï¼ˆatomic writeï¼‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨
 * - ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã‚“ã§ã‹ã‚‰ rename() ã§ç½®ãæ›ãˆã‚‹ã“ã¨ã§ã€
 *   æ›¸ãè¾¼ã¿ä¸­ã®éšœå®³ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ç ´æã‚’é˜²ã
 */
function save_tasks(array $tasks): void {
    // array_values() ã§ã‚­ãƒ¼ã‚’æŒ¯ã‚Šç›´ã—ã¦é€£ç•ªã®é…åˆ—ã«ã™ã‚‹
    // ã“ã‚Œã«ã‚ˆã‚Šã€å‰Šé™¤æ“ä½œå¾Œã«æ­¯æŠœã‘ã«ãªã£ãŸã‚­ãƒ¼ã‚’æ•´ç†
    // JSON_PRETTY_PRINT ã§äººé–“ãŒèª­ã¿ã‚„ã™ã„æ•´å½¢ã•ã‚ŒãŸJSONã‚’å‡ºåŠ›
    // JSON_UNESCAPED_UNICODE ã§æ—¥æœ¬èªãªã©ã®Unicodeæ–‡å­—ã‚’ãã®ã¾ã¾å‡ºåŠ›ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ãªã„ï¼‰
    $json = json_encode(array_values($tasks), JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE);
    
    // ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ï¼ˆå…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«åã« .tmp ã‚’ä»˜åŠ ï¼‰
    $tmp = TASKS_FILE . '.tmp';
    
    // fopen() ã® 'wb' ãƒ¢ãƒ¼ãƒ‰ã§ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚¤ãƒŠãƒªæ›¸ãè¾¼ã¿ãƒ¢ãƒ¼ãƒ‰ã§é–‹ã
    // 'w' = writeï¼ˆæ–°è¦ä½œæˆã¾ãŸã¯ä¸Šæ›¸ãï¼‰ã€'b' = binaryï¼ˆæ”¹è¡Œã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›ã—ãªã„ï¼‰
    $fp = fopen($tmp, 'wb');
    
    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚ªãƒ¼ãƒ—ãƒ³ã«å¤±æ•—ã—ãŸå ´åˆã¯ä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼
    // false === ã§ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚¤ãƒ³ã‚¿ãŒå–å¾—ã§ããªã‹ã£ãŸã“ã¨ã‚’å³å¯†ã«æ¤œè¨¼
    if ($fp === false) {
        throw new RuntimeException('Cannot write temp file');
    }
    
    // fwrite() ã§JSONæ–‡å­—åˆ—ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
    fwrite($fp, $json);
    
    // fclose() ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‰ã˜ã‚‹ï¼ˆãƒãƒƒãƒ•ã‚¡ã‚’ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã—ã¦ç¢ºå®Ÿã«æ›¸ãè¾¼ã¿ï¼‰
    fclose($fp);
    
    // rename() ã§ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æœ¬ç•ªãƒ•ã‚¡ã‚¤ãƒ«ã«ç½®ãæ›ãˆï¼ˆã‚¢ãƒˆãƒŸãƒƒã‚¯æ“ä½œï¼‰
    // UNIXç³»OSã§ã¯ rename() ã¯ã‚¢ãƒˆãƒŸãƒƒã‚¯ãªæ“ä½œã®ãŸã‚ã€
    // èª­ã¿è¾¼ã¿ä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹ãŒä¸­é€”åŠç«¯ãªãƒ‡ãƒ¼ã‚¿ã‚’èª­ã‚€ã“ã¨ãŒãªã„
    // ã“ã‚Œã«ã‚ˆã‚Šã€æ›¸ãè¾¼ã¿ä¸­ã«ã‚µãƒ¼ãƒãƒ¼ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ã¦ã‚‚ã€
    // å¤ã„å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿ã‹ã€æ–°ã—ã„å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿ã®ã©ã¡ã‚‰ã‹ãŒæ®‹ã‚‹
    rename($tmp, TASKS_FILE);
}

/**
 * HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°ï¼ˆXSSå¯¾ç­–ï¼‰
 * 
 * @param string $s ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹æ–‡å­—åˆ—
 * @return string ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸæ–‡å­—åˆ—
 * 
 * ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®é‡è¦æ€§ã€‘
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’HTMLã«å‡ºåŠ›ã™ã‚‹éš›ã€å¿…ãšã“ã®é–¢æ•°ã‚’é€šã™ã“ã¨ã§
 * XSSï¼ˆã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚°ï¼‰æ”»æ’ƒã‚’é˜²ã
 */
function h(string $s): string { 
    // htmlspecialchars() ã¯ç‰¹æ®Šæ–‡å­—ã‚’HTMLã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«å¤‰æ›
    // ENT_QUOTES: ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã¨ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã®ä¸¡æ–¹ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    // ENT_SUBSTITUTE: ç„¡åŠ¹ãªã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ç½®æ›æ–‡å­—ã«å¤‰æ›ï¼ˆæ–‡å­—åŒ–ã‘é˜²æ­¢ï¼‰
    // 'UTF-8': æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ˜ç¤ºçš„ã«æŒ‡å®š
    return htmlspecialchars($s, ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8'); 
}

/**
 * ã‚¿ã‚¹ã‚¯é…åˆ—ã‹ã‚‰æŒ‡å®šIDã®ã‚¿ã‚¹ã‚¯ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¤œç´¢
 * 
 * @param array $tasks ã‚¿ã‚¹ã‚¯ã®é…åˆ—
 * @param string $id æ¤œç´¢ã™ã‚‹ã‚¿ã‚¹ã‚¯ID
 * @return int ã‚¿ã‚¹ã‚¯ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ -1
 * 
 * ã€è¨­è¨ˆä¸Šã®åˆ¤æ–­ã€‘
 * è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã« -1 ã‚’è¿”ã™ã“ã¨ã§ã€é…åˆ—ã®æœ‰åŠ¹ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0ä»¥ä¸Šï¼‰ã¨
 * æ˜ç¢ºã«åŒºåˆ¥ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹
 */
function find_task_index(array $tasks, string $id): int {
    // foreach ã§é…åˆ—ã®å„è¦ç´ ã¨ãã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
    // $i => $t ã®å½¢å¼ã§ã€$i ã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€$t ã¯è¦ç´ ã®å€¤
    foreach ($tasks as $i => $t) {
        // ã‚¿ã‚¹ã‚¯ã®IDã¨æ¤œç´¢IDã‚’æ¯”è¼ƒ
        // ?? '' ã§ã€IDã‚­ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç©ºæ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã†ï¼ˆNullåˆä½“æ¼”ç®—å­ï¼‰
        if (($t['id'] ?? '') === $id) return $i;
    }
    // è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã¯ -1 ã‚’è¿”ã™
    return -1;
}

// ============================================================================
// POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ï¼ˆã‚¿ã‚¹ã‚¯ã®è¿½åŠ ãƒ»æ›´æ–°ãƒ»å‰Šé™¤ï¼‰
// ============================================================================

// --- Handle POST actions ---
// ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ ¼ç´ã™ã‚‹é…åˆ—ã‚’åˆæœŸåŒ–
$errors = [];

// ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ãŒPOSTã‹ã©ã†ã‹ã‚’ç¢ºèª
// $_SERVER['REQUEST_METHOD'] ã¯HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã‚’å«ã‚€ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼
    // hash_equals() ã¯ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒã‚’é˜²ãå®šæ•°æ™‚é–“æ¯”è¼ƒé–¢æ•°
    // é€šå¸¸ã® === æ¯”è¼ƒã¯æ–‡å­—åˆ—ã®å…ˆé ­ã‹ã‚‰é †ã«æ¯”è¼ƒã™ã‚‹ãŸã‚ã€
    // ä¸€è‡´ã—ãªã„ä½ç½®ã«ã‚ˆã£ã¦å‡¦ç†æ™‚é–“ãŒå¤‰ã‚ã‚Šã€æ”»æ’ƒè€…ãŒãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¨æ¸¬ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
    // hash_equals() ã¯å¸¸ã«å…¨æ–‡å­—åˆ—ã‚’æ¯”è¼ƒã™ã‚‹ãŸã‚ã€ã“ã®è„†å¼±æ€§ã‚’é˜²ã
    if (!hash_equals($CSRF, $_POST['csrf_token'] ?? '')) {
        // CSRF ãƒˆãƒ¼ã‚¯ãƒ³ãŒä¸€è‡´ã—ãªã„å ´åˆã¯ 400 Bad Request ã‚’è¿”ã™
        http_response_code(400);
        $errors[] = 'Invalid CSRF token.';
    } else {
        // CSRFæ¤œè¨¼ãŒæˆåŠŸã—ãŸå ´åˆã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¿œã˜ãŸå‡¦ç†ã‚’å®Ÿè¡Œ
        
        // $_POST['action'] ã‹ã‚‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ç¨®é¡ã‚’å–å¾—
        // ?? '' ã§ã€action ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç©ºæ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã†
        $action = $_POST['action'] ?? '';
        
        // ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        $tasks = load_tasks();
        
        // ç¾åœ¨æ™‚åˆ»ã‚’ISO 8601å½¢å¼ã§å–å¾—ï¼ˆä¾‹: 2024-11-26T10:30:00+09:00ï¼‰
        // 'c' ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³æƒ…å ±ã‚’å«ã‚€æ¨™æº–çš„ãªæ—¥æ™‚è¡¨ç¾
        $now = date('c');

        // ============================================================================
        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ã‚¿ã‚¹ã‚¯ã®è¿½åŠ 
        // ============================================================================
        if ($action === 'add') {
            // ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
            // (string) ã§æ–‡å­—åˆ—å‹ã«ã‚­ãƒ£ã‚¹ãƒˆ
            // ?? '' ã§å€¤ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç©ºæ–‡å­—åˆ—
            // trim() ã§å‰å¾Œã®ç©ºç™½æ–‡å­—ã‚’é™¤å»
            $title = trim((string)($_POST['title'] ?? ''));
            
            // èª¬æ˜ï¼ˆdescriptionï¼‰ã‚‚åŒæ§˜ã«å–å¾—
            $desc  = trim((string)($_POST['description'] ?? ''));
            
            // ã‚¿ã‚¤ãƒˆãƒ«ãŒç©ºã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
            // ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆé …ç›®ã¨ã—ã¦æ‰±ã†
            if ($title === '') {
                $errors[] = 'Title is required.';
            } else {
                // æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’é…åˆ—ã«è¿½åŠ 
                $tasks[] = [
                    // random_bytes(8) ã§8ãƒã‚¤ãƒˆã®ä¹±æ•°ã‚’ç”Ÿæˆã—ã€16é€²æ•°ã«å¤‰æ›
                    // ã“ã‚Œã«ã‚ˆã‚Š16æ–‡å­—ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã‚’ç”Ÿæˆ
                    'id' => bin2hex(random_bytes(8)),
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸã‚¿ã‚¤ãƒˆãƒ«
                    'title' => $title,
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸèª¬æ˜ï¼ˆä»»æ„é …ç›®ï¼‰
                    'description' => $desc,
                    // åˆæœŸçŠ¶æ…‹ã¯æœªå®Œäº†ï¼ˆfalseï¼‰
                    'done' => false,
                    // ä½œæˆæ—¥æ™‚ã‚’è¨˜éŒ²
                    'created_at' => $now,
                    // æ›´æ–°æ—¥æ™‚ã‚‚åˆæœŸçŠ¶æ…‹ã§ã¯ä½œæˆæ—¥æ™‚ã¨åŒã˜
                    'updated_at' => $now,
                ];
                
                // æ›´æ–°ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯é…åˆ—ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
                save_tasks($tasks);
                
                // PRG ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆPost-Redirect-Getï¼‰ã‚’å®Ÿè£…
                // POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆå¾Œã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã“ã¨ã§ã€
                // ãƒ–ãƒ©ã‚¦ã‚¶ã®å†èª­ã¿è¾¼ã¿æ™‚ã«åŒã˜POSTãŒå†å®Ÿè¡Œã•ã‚Œã‚‹ã®ã‚’é˜²ã
                // $_SERVER['REQUEST_URI'] ã¯ç¾åœ¨ã®URIã‚’è¿”ã™
                header('Location: ' . $_SERVER['REQUEST_URI']);
                
                // exit ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œã‚’çµ‚äº†ã—ã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’ç¢ºå®Ÿã«å®Ÿè¡Œ
                exit;
            }
        
        // ============================================================================
        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ã‚¿ã‚¹ã‚¯ã®å®Œäº†/æœªå®Œäº†ã®åˆ‡ã‚Šæ›¿ãˆ
        // ============================================================================
        } elseif ($action === 'toggle') {
            // ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯IDã‚’å–å¾—
            $id = (string)($_POST['id'] ?? '');
            
            // find_task_index() é–¢æ•°ã§è©²å½“ã™ã‚‹ã‚¿ã‚¹ã‚¯ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¤œç´¢
            $idx = find_task_index($tasks, $id);
            
            // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒ 0 ä»¥ä¸Šã®å ´åˆã€ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã£ãŸ
            if ($idx >= 0) {
                // done ãƒ•ãƒ©ã‚°ã‚’åè»¢ï¼ˆtrue â†’ falseã€false â†’ trueï¼‰
                // !() ã§è«–ç†å¦å®šã‚’é©ç”¨
                // ?? false ã§ã€done ã‚­ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ false ã¨ã—ã¦æ‰±ã†
                $tasks[$idx]['done'] = !($tasks[$idx]['done'] ?? false);
                
                // æ›´æ–°æ—¥æ™‚ã‚’ç¾åœ¨æ™‚åˆ»ã«æ›´æ–°
                $tasks[$idx]['updated_at'] = $now;
                
                // å¤‰æ›´ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
                save_tasks($tasks);
                
                // PRG ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                header('Location: ' . $_SERVER['REQUEST_URI']);
                exit;
            } else {
                // ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
                $errors[] = 'Task not found.';
            }
        
        // ============================================================================
        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ã‚¿ã‚¹ã‚¯ã®å‰Šé™¤
        // ============================================================================
        } elseif ($action === 'delete') {
            // å‰Šé™¤å¯¾è±¡ã®ã‚¿ã‚¹ã‚¯IDã‚’å–å¾—
            $id = (string)($_POST['id'] ?? '');
            
            // ã‚¿ã‚¹ã‚¯ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¤œç´¢
            $idx = find_task_index($tasks, $id);
            
            // ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆ
            if ($idx >= 0) {
                // array_splice() ã§é…åˆ—ã‹ã‚‰è¦ç´ ã‚’å‰Šé™¤
                // ç¬¬1å¼•æ•°: å¯¾è±¡é…åˆ—
                // ç¬¬2å¼•æ•°: å‰Šé™¤é–‹å§‹ä½ç½®
                // ç¬¬3å¼•æ•°: å‰Šé™¤ã™ã‚‹è¦ç´ æ•°ï¼ˆ1å€‹ï¼‰
                // ã“ã®é–¢æ•°ã¯é…åˆ—ã‚’å¤‰æ›´ã™ã‚‹ãŸã‚ã€æˆ»ã‚Šå€¤ã¯ä½¿ç”¨ã›ãš $tasks ãŒç›´æ¥æ›´æ–°ã•ã‚Œã‚‹
                array_splice($tasks, $idx, 1);
                
                // å¤‰æ›´ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
                save_tasks($tasks);
                
                // PRG ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                header('Location: ' . $_SERVER['REQUEST_URI']);
                exit;
            } else {
                // ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
                $errors[] = 'Task not found.';
            }
        }
    }
}

// ============================================================================
// è¡¨ç¤ºç”¨ã®ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
// ============================================================================

// POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†å¾Œã€ã¾ãŸã¯é€šå¸¸ã®GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å ´åˆã€
// æœ€æ–°ã®ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚“ã§è¡¨ç¤ºç”¨ã®å¤‰æ•°ã«æ ¼ç´
$tasks = load_tasks();

// ============================================================================
// HTMLå‡ºåŠ›é–‹å§‹
// ============================================================================

// ?> ã§PHPãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†ã—ã€HTMLå‡ºåŠ›ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
// ã“ã®å¾Œã®ã‚³ãƒ¼ãƒ‰ã¯HTMLã¨ã—ã¦è§£é‡ˆã•ã‚Œã‚‹
?><!DOCTYPE html>
<html lang="ja">
<head>
  <!-- UTF-8 æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’æŒ‡å®šï¼ˆæ—¥æœ¬èªè¡¨ç¤ºã«å¿…é ˆï¼‰ -->
  <meta charset="UTF-8">
  
  <!-- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ã®ãŸã‚ã® viewport è¨­å®š -->
  <!-- width=device-width: ç”»é¢å¹…ã‚’ãƒ‡ãƒã‚¤ã‚¹ã®å¹…ã«åˆã‚ã›ã‚‹ -->
  <!-- initial-scale=1.0: åˆæœŸã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’100%ã«è¨­å®š -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¿ãƒ–ã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰ -->
  <title>ã‚·ãƒ³ãƒ—ãƒ«ãƒ»ã‚¿ã‚¹ã‚¯ãƒˆãƒ©ãƒƒã‚«ãƒ¼</title>
  
  <!-- ============================================================================
       CSS ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©ï¼ˆåœ§ç¸®ç‰ˆï¼‰
       ============================================================================ -->
  <style>:root{--bg:#0f172a;--card:#111827;--ink:#e5e7eb;--muted:#9ca3af;--accent:#22c55e;--danger:#ef4444}*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;background:var(--bg);color:var(--ink)}.container{max-width:900px;margin:40px auto;padding:16px}.card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}h1{margin:0 0 16px;font-size:22px}form.add{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:20px}input[type="text"],textarea{width:100%;background:#0b1220;color:var(--ink);border:1px solid #24324a;border-radius:12px;padding:12px}textarea{min-height:80px;resize:vertical}.row{display:flex;gap:12px;align-items:center}button{border:none;border-radius:10px;padding:10px 14px;cursor:pointer}.btn{background:#334155;color:var(--ink)}.btn.primary{background:var(--accent);color:#06210e;font-weight:700}.btn.toggle{background:#1f2937;color:#fff}.btn.delete{background:var(--danger)}.errors{background:#3f1f1f;border:1px solid #7f1d1d;padding:12px;border-radius:12px;margin-bottom:16px}table{width:100%;border-collapse:collapse}th,td{border-bottom:1px solid #1f2937;padding:10px;text-align:left;vertical-align:top}th{color:var(--muted);font-weight:normal}.empty{color:var(--muted);padding:12px}.title.done{text-decoration:line-through;opacity:.6}.meta{color:var(--muted);font-size:12px}@media (prefers-color-scheme:light){:root{--bg:#f3f4f6;--card:#fff;--ink:#0b1220;--muted:#6b7280}input[type="text"],textarea{background:#fff;color:#111827;border:1px solid #d1d5db}.btn{background:#e5e7eb;color:#111827}.btn.primary{color:#064420}}</style>
</head>
<body>
  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div class="container">
    <!-- ã‚«ãƒ¼ãƒ‰è¦ç´ ï¼ˆãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ï¼‰ -->
    <div class="card">
      <!-- ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ« -->
      <h1>ã‚·ãƒ³ãƒ—ãƒ«ãƒ»ã‚¿ã‚¹ã‚¯ãƒˆãƒ©ãƒƒã‚«ãƒ¼</h1>

      <!-- ============================================================================
           ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
           ============================================================================ -->
      <?php if ($errors): ?>
        <!-- $errors é…åˆ—ãŒç©ºã§ãªã„å ´åˆã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º -->
        <div class="errors">
          <?php foreach ($errors as $e): ?>
            <!-- å„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º -->
            <!-- h() é–¢æ•°ã§XSSå¯¾ç­–ã®ãŸã‚ã‚¨ã‚¹ã‚±ãƒ¼ãƒ— -->
            <div>âš ï¸ <?= h($e) ?></div>
          <?php endforeach; ?>
        </div>
      <?php endif; ?>

      <!-- ============================================================================
           ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ 
           ============================================================================ -->
      <form class="add" method="post">
        <!-- CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ hidden ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã—ã¦åŸ‹ã‚è¾¼ã¿ -->
        <!-- h() é–¢æ•°ã§ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ï¼ˆå¿µã®ãŸã‚ï¼‰ -->
        <input type="hidden" name="csrf_token" value="<?= h($CSRF) ?>">
        
        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ç¨®é¡ã‚’æŒ‡å®šï¼ˆ'add' = ã‚¿ã‚¹ã‚¯è¿½åŠ ï¼‰ -->
        <input type="hidden" name="action" value="add">
        
        <!-- ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›æ¬„ -->
        <div>
          <label for="title">ã‚¿ã‚¤ãƒˆãƒ« <span class="meta">(å¿…é ˆ)</span></label>
          <!-- required å±æ€§ã§ãƒ–ãƒ©ã‚¦ã‚¶å´ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹åŒ– -->
          <!-- placeholder ã§ãƒ’ãƒ³ãƒˆãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤º -->
          <input type="text" id="title" name="title" placeholder="ä¾‹:è³‡æ–™ä½œæˆã€è²·ã„ç‰©ã€ãƒ¡ãƒ¼ãƒ«è¿”ä¿¡ ãªã©" required>
        </div>
        
        <!-- èª¬æ˜å…¥åŠ›æ¬„ -->
        <div>
          <label for="description">èª¬æ˜ <span class="meta">(ä»»æ„)</span></label>
          <!-- textarea ã§è¤‡æ•°è¡Œã®ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‚’å¯èƒ½ã« -->
          <textarea id="description" name="description" placeholder="ãƒ¡ãƒ¢ã‚„è©³ç´°ãŒã‚ã‚Œã°ã©ã†ã"></textarea>
        </div>
        
        <!-- é€ä¿¡ãƒœã‚¿ãƒ³ã¨ãƒ’ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div class="row">
          <!-- type="submit" ã§ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒœã‚¿ãƒ³ã¨ã—ã¦æ©Ÿèƒ½ -->
          <button class="btn primary" type="submit">ï¼‹ ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </button>
          <span class="meta">ãƒ•ã‚©ãƒ¼ãƒ ã§é€ä¿¡ã™ã‚‹ã¨ä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</span>
        </div>
      </form>

      <!-- ============================================================================
           ã‚¿ã‚¹ã‚¯ä¸€è¦§ã®è¡¨ç¤º
           ============================================================================ -->
      <h2 style="font-size:18px; margin: 0 0 10px;">ã‚¿ã‚¹ã‚¯ä¸€è¦§</h2>
      
      <?php if (empty($tasks)): ?>
        <!-- ã‚¿ã‚¹ã‚¯ãŒ1ã¤ã‚‚ãªã„å ´åˆã®è¡¨ç¤º -->
        <div class="empty">ã¾ã ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>
      <?php else: ?>
        <!-- ã‚¿ã‚¹ã‚¯ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ãƒ†ãƒ¼ãƒ–ãƒ«ã§è¡¨ç¤º -->
        <table>
          <thead>
            <tr>
              <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
              <th>çŠ¶æ…‹</th>
              <th>ã‚¿ã‚¤ãƒˆãƒ« / èª¬æ˜</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
          <?php 
          // array_reverse() ã§é…åˆ—ã‚’é€†é †ã«ã™ã‚‹ã“ã¨ã§ã€æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’ä¸Šã«è¡¨ç¤º
          // foreach ã§å„ã‚¿ã‚¹ã‚¯ã‚’ãƒ«ãƒ¼ãƒ—å‡¦ç†
          foreach (array_reverse($tasks) as $t): 
          ?>
            <tr>
              <!-- ============================================================================
                   çŠ¶æ…‹åˆ—: å®Œäº†/æœªå®Œäº†ã®è¡¨ç¤º
                   ============================================================================ -->
              <td style="width:90px;">
                <?php 
                // ä¸‰é …æ¼”ç®—å­ã§ done ãƒ•ãƒ©ã‚°ã«å¿œã˜ã¦è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
                // true ã®å ´åˆ: âœ… å®Œäº†
                // false ã®å ´åˆ: ğŸ•’ æœªå®Œäº†
                ?>
                <?= $t['done'] ? 'âœ… å®Œäº†' : 'ğŸ•’ æœªå®Œäº†' ?>
              </td>
              
              <!-- ============================================================================
                   ã‚¿ã‚¤ãƒˆãƒ«ãƒ»èª¬æ˜ãƒ»ãƒ¡ã‚¿æƒ…å ±åˆ—
                   ============================================================================ -->
              <td>
                <!-- ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¡¨ç¤º -->
                <!-- done ãƒ•ãƒ©ã‚°ãŒ true ã®å ´åˆã€'done' ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ï¼ˆå–ã‚Šæ¶ˆã—ç·šè¡¨ç¤ºï¼‰ -->
                <!-- h() é–¢æ•°ã§XSSå¯¾ç­–ã®ãŸã‚ã‚¨ã‚¹ã‚±ãƒ¼ãƒ— -->
                <div class="title <?= $t['done'] ? 'done' : '' ?>"><?= h($t['title']) ?></div>
                
                <?php if (!empty($t['description'])): ?>
                  <!-- èª¬æ˜ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿è¡¨ç¤º -->
                  <!-- nl2br() ã§æ”¹è¡Œæ–‡å­—ã‚’ <br> ã‚¿ã‚°ã«å¤‰æ›ï¼ˆè¤‡æ•°è¡Œè¡¨ç¤ºï¼‰ -->
                  <!-- h() é–¢æ•°ã§ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç† -->
                  <div class="meta">èª¬æ˜:<?= nl2br(h($t['description'])) ?></div>
                <?php endif; ?>
                
                <!-- ä½œæˆæ—¥æ™‚ã¨æ›´æ–°æ—¥æ™‚ã‚’è¡¨ç¤º -->
                <!-- ?? $t['created_at'] ã§ã€updated_at ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ created_at ã‚’ä½¿ç”¨ -->
                <div class="meta">ä½œæˆ:<?= h($t['created_at']) ?> â”‚ æ›´æ–°:<?= h($t['updated_at'] ?? $t['created_at']) ?></div>
              </td>
              
              <!-- ============================================================================
                   æ“ä½œåˆ—: å®Œäº†åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã¨å‰Šé™¤ãƒœã‚¿ãƒ³
                   ============================================================================ -->
              <td style="width:220px;">
                <!-- å®Œäº†/æœªå®Œäº†åˆ‡ã‚Šæ›¿ãˆãƒ•ã‚©ãƒ¼ãƒ  -->
                <!-- display:inline ã§æ¨ªä¸¦ã³ã«é…ç½® -->
                <form method="post" style="display:inline;">
                  <!-- CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’åŸ‹ã‚è¾¼ã¿ -->
                  <input type="hidden" name="csrf_token" value="<?= h($CSRF) ?>">
                  
                  <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ç¨®é¡: toggleï¼ˆåˆ‡ã‚Šæ›¿ãˆï¼‰ -->
                  <input type="hidden" name="action" value="toggle">
                  
                  <!-- æ“ä½œå¯¾è±¡ã®ã‚¿ã‚¹ã‚¯IDã‚’åŸ‹ã‚è¾¼ã¿ -->
                  <input type="hidden" name="id" value="<?= h($t['id']) ?>">
                  
                  <!-- ãƒœã‚¿ãƒ³ã®ãƒ©ãƒ™ãƒ«ã‚’ done ãƒ•ãƒ©ã‚°ã«å¿œã˜ã¦å¤‰æ›´ -->
                  <!-- true: æœªå®Œäº†ã«æˆ»ã™ã€false: å®Œäº†ã«ã™ã‚‹ -->
                  <button class="btn toggle" type="submit"><?= $t['done'] ? 'æœªå®Œäº†ã«æˆ»ã™' : 'å®Œäº†ã«ã™ã‚‹' ?></button>
                </form>
                
                <!-- å‰Šé™¤ãƒ•ã‚©ãƒ¼ãƒ  -->
                <!-- onsubmit ã§ JavaScript ã® confirm() é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã€ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º -->
                <!-- return false ã§é€ä¿¡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€return true ã§é€ä¿¡ã‚’å®Ÿè¡Œ -->
                <form method="post" style="display:inline;" onsubmit="return confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹?');">
                  <!-- CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’åŸ‹ã‚è¾¼ã¿ -->
                  <input type="hidden" name="csrf_token" value="<?= h($CSRF) ?>">
                  
                  <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ç¨®é¡: deleteï¼ˆå‰Šé™¤ï¼‰ -->
                  <input type="hidden" name="action" value="delete">
                  
                  <!-- æ“ä½œå¯¾è±¡ã®ã‚¿ã‚¹ã‚¯IDã‚’åŸ‹ã‚è¾¼ã¿ -->
                  <input type="hidden" name="id" value="<?= h($t['id']) ?>">
                  
                  <!-- å‰Šé™¤ãƒœã‚¿ãƒ³ -->
                  <button class="btn delete" type="submit">å‰Šé™¤</button>
                </form>
              </td>
            </tr>
          <?php endforeach; ?>
          </tbody>
        </table>
      <?php endif; ?>
    </div>

    <!-- ============================================================================
         ãƒ•ãƒƒã‚¿ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã«é–¢ã™ã‚‹æ³¨æ„æ›¸ã
         ============================================================================ -->
    <p class="meta" style="margin-top:12px; text-align:center;">
      ä¿å­˜å…ˆ:<code><?= h(basename(TASKS_FILE)) ?></code>(åŒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª) â”‚ ãƒ•ã‚¡ã‚¤ãƒ«ã§ã®ç°¡æ˜“ä¿å­˜ã®ãŸã‚ã€æ©Ÿå¯†æƒ…å ±ã®å…¥åŠ›ã¯é¿ã‘ã¦ãã ã•ã„ã€‚
    </p>
  </div>
</body>
</html>
